<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>謎解きウォークラリー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 2s ease-in-out;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        .container {
            text-align: center;
            color: white;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            font-size: 1.5rem;
            max-width: 90%;
            padding: 2rem;
        }
        .visible {
            opacity: 1;
        }
        .version {
            font-size: 0.8rem;
            color: #6b7280; /* gray-500 */
            margin-top: 1rem;
        }
        #return-button {
            transition: opacity 0.5s ease-in-out;
            /* ボタンが押されたときにブラウザのデフォルト動作を無効化 */
            touch-action: none;
        }
        .hidden {
            display: none;
            opacity: 0;
        }
    </style>
</head>
<body class="bg-white">

    <div id="message-container" class="container">
        <!-- 謎解き成功後に表示されるメッセージ -->
        <p id="main-message">キーワードは「風」です。</p>
        <p>次の場所へ移動してください。</p>
        <div id="version-info" class="version"></div>
        <button id="return-button" class="mt-8 px-6 py-3 bg-gray-700 text-white rounded-full shadow-lg hover:bg-gray-600 focus:outline-none hidden">
            戻る
        </button>
    </div>

    <script>
        // DOM要素と状態変数を取得
        const body = document.body;
        const messageContainer = document.getElementById('message-container');
        const mainMessageElement = document.getElementById('main-message');
        const versionInfoElement = document.getElementById('version-info');
        const returnButton = document.getElementById('return-button');

        // バージョン情報を定義
        const versionInfo = "v3.4";

        // タッチイベントの追跡用変数
        let lastTouchX = null;
        let lastTouchY = null;
        let directionCount = 0;
        let lastDirection = null;
        let swipeLeftCount = 0;
        let tapCount = 0;
        let isSwiping = false;
        const threshold = 20; // 移動距離の閾値（ピクセル）
        const requiredMovesCircle = 5; // 円を描くのに必要な方向転換回数
        const requiredSwipeLeft = 5; // 右から左へのスワイプ回数
        const requiredTaps = 3; // タップの回数

        // 謎解きの状態管理
        let riddleSolved = false;
        let isActivated = false;
        
        // イベントリスナーのセットアップ関数
        function setupEventListeners() {
            body.addEventListener('touchmove', handleTouchMove);
            body.addEventListener('touchend', handleTouchEnd);
        }

        // イベントリスナーの削除関数
        function removeEventListeners() {
            body.removeEventListener('touchmove', handleTouchMove);
            body.removeEventListener('touchend', handleTouchEnd);
        }

        // touchmoveイベントのハンドラー
        function handleTouchMove(e) {
            e.preventDefault();
            if (isActivated) return;

            const touch = e.touches[0];
            const currentX = touch.clientX;
            const currentY = touch.clientY;
            
            // 指が一定距離動いたらスワイプ中と判断
            if (Math.abs(currentX - lastTouchX) > 5 || Math.abs(currentY - lastTouchY) > 5) {
                isSwiping = true;
            }

            if (lastTouchX !== null && lastTouchY !== null) {
                const deltaX = currentX - lastTouchX;
                const deltaY = currentY - lastTouchY;

                let currentDirection = null;
                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > threshold) {
                    currentDirection = (deltaX > 0) ? 'right' : 'left';
                    if (currentDirection === 'left') {
                        swipeLeftCount++;
                        console.log(`右から左へのスワイプ回数: ${swipeLeftCount}`);
                    }
                } else if (Math.abs(deltaY) > Math.abs(deltaX) && Math.abs(deltaY) > threshold) {
                    currentDirection = (deltaY > 0) ? 'down' : 'up';
                }
                
                if (currentDirection && currentDirection !== lastDirection) {
                    directionCount++;
                    lastDirection = currentDirection;
                    console.log(`現在の方向転換回数: ${directionCount}`);
                }
            }
            
            lastTouchX = currentX;
            lastTouchY = currentY;

            if (directionCount >= requiredMovesCircle) {
                activateRiddle('circle');
            }
        }

        // touchendイベントのハンドラー
        function handleTouchEnd(e) {
            if (isActivated) return;

            if (isSwiping) {
                // スワイプ操作が完了
                isSwiping = false;
                if (swipeLeftCount >= requiredSwipeLeft) {
                    // スワイプ回数が規定値に達したら、タップカウントをリセット
                    // これで、次のタップで謎解きが発動するようになる
                    tapCount = 0;
                }
            } else {
                // タップ操作
                if (swipeLeftCount >= requiredSwipeLeft) {
                    tapCount++;
                    console.log(`現在のタップ回数: ${tapCount}`);
                    if (tapCount >= requiredTaps) {
                        activateRiddle('swipe_tap');
                    }
                }
            }

            // 指が離れたらすべてのカウントをリセット
            directionCount = 0;
            lastDirection = null;
            lastTouchX = null;
            lastTouchY = null;
            // touchendではswipeLeftCountをリセットしない
            // 次のtouchendでtapCountを増やすため
        }
        
        // 謎解き成功時の処理
        function activateRiddle(riddleType) {
            if (riddleSolved) return;
            isActivated = true;
            riddleSolved = true;

            removeEventListeners();

            body.classList.remove('bg-white');
            body.classList.add('bg-gray-900');

            messageContainer.classList.add('visible');
            versionInfoElement.textContent = `バージョン: ${versionInfo}`;
            
            if (riddleType === 'circle') {
                mainMessageElement.textContent = "キーワードは「風」です。";
            } else if (riddleType === 'swipe_tap') {
                mainMessageElement.textContent = "キーワードは「月」です。";
            }
            
            returnButton.classList.remove('hidden');

            // 5秒後に次のページへ遷移
            setTimeout(() => {
                window.location.href = "https://www.google.com";
            }, 5000);
        }

        // 戻るボタンのイベントリスナー
        returnButton.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            
            // 状態を初期化
            riddleSolved = false;
            isActivated = false;
            directionCount = 0;
            lastDirection = null;
            swipeLeftCount = 0;
            tapCount = 0;
            
            // 画面をリセット
            body.classList.remove('bg-gray-900');
            body.classList.add('bg-white');
            messageContainer.classList.remove('visible');
            returnButton.classList.add('hidden');
            
            // イベントリスナーを再登録
            setupEventListeners();
        });

        // 最初のイベントリスナー設定
        setupEventListeners();

    </script>
</body>
</html>
